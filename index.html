<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<link REL="SHORTCUT ICON" HREF="shanti.ico">
	<title>SHANTI Folio</title>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>	
	<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
	<script src="jquery.ui.touch-punch.min.js"></script>
	<script type="text/javascript" src="https://apis.google.com/js/api.js"></script>
	<script src="ckeditor/ckeditor.js"></script>
	<script src="helpers.js"></script>
	<script src="layout.js"></script>
	<script src="share.js"></script>
	<script src="collect.js"></script>
	<script src="player.js"></script>
	<script src="data.js"></script>
	<script src="item.js"></script>

	<style type="text/css">
		body { 			font-family:Verdana,Geneva,sans-serif;font-size:12px;
						padding:0px;border:0px;margin:8px;
						}
		.sf-splash { 	text-align:center;position:absolute;top:200px;left:calc(50% - 240px);
						}
		.sf-main {		min-width:1024px;margin:0px;padding:0px;box-sizing:border-box;
						}
		.sf-menu {		width:100%;height:32px;color:#666;
						background-color:#ddd;opacity:inherit;
						border-top-left-radius:6px;border-top-right-radius:6px;
						}
		.sf-body {		width:100%;min-height:300px;color:#666;border:2px solid #ddd;	
						background-color:#fff;opacity:inherit;box-sizing:border-box;
						}
		.sf-show {		width:100%;height:100vh;
						}
		.sf-menuItem {	margin-left:50px;cursor:pointer;color:#000;
						}
		.sf-breadItem {	text-align:left;float:right;margin-right:12px;margin-top:8px;
						}
		.sf-gallery {  	display:inline-block;text-align:center;width:150px;
						padding-top:0px;padding-bottom:8px;padding-left:12px;padding-right:14px;
						background-color:#ddd;color:#999;
						}
		.sf-galleryContent { overflow-x:hidden;overflow-y:auto;background-color:#f8f8f8;
						border:1px solid #bbb;
						}
		.sf-galleryLab  { padding:8px;border-bottom:1px solid #999;text-align:center;
						min-height:40px;background-color:#f8f8f8;
						}
		.sf-galleryTool { text-align:left;padding-top:10px;
						}
		.sf-galleryBut  { cursor:pointer;margin-right:46px;
						}
		.sf-galleryPage { cursor:pointer;
						}
		.sf-projectPage { display:inline-block;overflow-x:hidden;overflow-y:auto;
						width:430px;color:#999;border-right:1px solid #ccc;height:calc(100vh - 82px);
						padding-right:16px;margin:16px;vertical-align:top;
						}
		.sf-projectItems { width:440px;text-align:center;color:#aaa;margin-top:-16px;
						}
		.sf-itemsPicker { position:absolute;overflow-x:hidden;overflow-y:auto;top:42px;left:644px;
						margin:18px;color:#aaa;text-align:left;min-width:160px;margin-top:20px;
						margin-right:0px;
						}
		.sf-item, .sf-pitem	{ display:inline-block;width:130px;height:64px;padding-bottom:40px;
						text-align:center;margin-right:16px;color:#888;overflow:hidden;vertical-align:top;
						}
		.sf-itemPic { 	width:128px;height:64px;border:1px solid #999;cursor:pointer;overflow:hidden;
						}
		.sf-player { 	height:calc(100% - 4px);width:100%;color:#000;
						}
		.sf-playerPane{	display:inline-block;box-sizing:border-box;background-color:#eeeeee;
						overflow-x:hidden;overflow-y:auto;padding:8px;
						}
		.sf-playerItem{	border-top:8px dotted #ccc;cursor:zoom-in;margin:0px;padding:0px;
						}
		.sf-playerItemInt{ cursor:default;margin:0px;padding:0px;
						}
		.sf-layoutParams { display:inline-block;width:50%;text-align:left;color:#888;margin:12px;
						display:inline-block;margin-right:24px;
						}
		.sf-layoutSizer { display:inline-block;width:calc(50% - 55px);height:400px;cursor:pointer;
						text-align:left;color:#999;margin-bottom:20px;margin-right:16px;vertical-align:top;
						}
		.sf-layoutPcts 	{ border:1px solid #999;border-radius:16px;padding:2px;color:#666;
						}
		.sf-sizerTop { 	box-sizing:border-box;overflow:hidden;margin:1px;
						background-color:#ddd;text-align:center;
						}
		.sf-sizerLeft { display:inline-block;box-sizing:border-box;margin:1px;overflow:hidden;
						background-color:#ddd;text-align:center;
						}
		.sf-sizerMid { 	display:inline-block;box-sizing:border-box;margin:1px;overflow:hidden;
						background-color:#ddd;text-align:center;
						}
		.sf-sizerRight { display:inline-block;box-sizing:border-box;margin:1px;overflow:hidden;
						background-color:#ddd;text-align:center;
						}
		.sf-sizerBot { 	box-sizing:border-box;overflow:hidden;margin:1px;
						background-color:#ddd;text-align:center;
						}
		.sf-previewTitle { margin-top:8px;margin-bottom:-4px;color:#999;font-weight:bold;
						}
		.sf-pullDown {	position:absolute;background-color:#ddd;width:100px; 
						}
		.sf-doButs {  	text-align:center;cursor:pointer;vertical-align:middle;
						display:inline-block;text-align:center;padding:10px;font-size:14px;
						}
		.sf-itemBut  { 	cursor:pointer;margin-right:20px;vertical-align:-4px;
						}
		.sf-pullDownItem {	padding-bottom:6px;cursor:pointer;width:92px;padding:6px;
						padding-left:8px;padding-right:0px;color:#999;
						}
		.sf-pullDownItem:hover{ background-color:#bbb;color:#eee
						}
		.sf-citation	{ text-align:right;cursor:pointer;font-style:italic;
						}
		.sf-navigation  { position:absolute;padding:16px;font-style:italic;
						}
		.sf-navButs  	{ position:absolute;cursor:pointer;
						}
		.sf-lightBox	{ position:absolute;padding:16px;border-radius:6px;z-index:2500;
						background-color:#f8f8f8;font-size:12px;
						}
		.sf-lightBoxTitle { color:#666;font-weight:bold;font-size:18px;
						}
		.sf-is {		border-radius:12px;padding-left:8px;padding-right:8px;padding-top:3px;padding-bottom:2px;
						border:1px solid #ccc;font-size:12px;width:95%;color:#666;
						}
		.sf-bs {		border-radius:16px;padding-left:8px;padding-right:8px;padding-top:1px;color:#666;
						font-size:12px;height:23px;background-color:#e8e8e8;cursor:pointer;border:1px solid #ccc;
						}
		.unselectable { -moz-user-select: none;     -khtml-user-select: none;
		   			 	-webkit-user-select: none;  -ms-user-select: none;   user-select: none;
		   				}
		.selectable { 	-moz-user-select: text;     -khtml-user-select: text;
		   			 	-webkit-user-select: text;  -ms-user-select: text;   user-select: text;
		   				}
		*[contenteditable] 	{   -webkit-user-select: auto !important; }
	
	</style>
</head>
<body>
	<div id="splashDiv" class="sf-splash"><img src="flogo.png"></div>
	<div id="mainDiv" class="sf-main unselectable" style="opacity:0">	
		<div id="menuDiv" class="sf-menu" >
			<img src="img/menuheader.png">
			<span style="vertical-align:10px">
				S H A N T l
				<span style="margin-left:100px"></span>
				<span id="editMenu" class="sf-menuItem" style="margin-left:100px">Edit</span>
				<span id="itemMenu" class="sf-menuItem"> Items</span>
				<span id="portfolioMenu" class="sf-menuItem"> Portfolios</span>
				<span id="shareMenu" class="sf-menuItem">Share</span>
				<span id="helpMenu" class="sf-menuItem">Help</span>
				<div id="breadMenu" class="sf-breadItem"><b>Portfolio:</b></div>
			</span>
		</div>
		<div id="bodyDiv" class="sf-body"></div>
	</div>	
<script>

//////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

var sf=null;																// Holds main folio object	
var curProject=-1,curPage=-1,curItem=-1;									// Keeps tabs on current places	
var playerObj=null,layoutObj=null,collectObj=null;							// Objects							
var dataObj=null,shareObj=null,itemObj=null;
var isMobile=false;															// Is it mobile?
var inhibitNav=false;														// Flag to inhibit navigation
var itemType="All types",itemFilter="";										// Filtering
var curMenu="splash";														// Current menu item
var drupalMan=false;														// Flag for drupal manager

		
$(window).resize(function() {											// ON WINDOW RESIZE
	if (sf && !isMobile)													// If loaded and not mobile
		sf.Draw();															// Redraw to adjust responsivivly
	});
			
$(document).ready(function() {											// ON PAGE LOADED
	isMobile=navigator.userAgent.match(/(ipad|iphone|ipod|android)/i) ? true : false; // Set mobile flag
	var url=window.location.search.substring(1);							// Get query string
	drupalMan=(""+url).match(/dr=/);										// If called from Drupal manager
	itemObj=new item();														// Load item object
 	dataObj=new data();														// Load data object
	shareObj=new share();													// Load layout object
	layoutObj=new layout();													// Load share object
	playerObj=new player();													// Load player object
  	sf=new folio();															// Load main object
	SendMessage("ready");													// Send ready mnessage

	if (drupalMan)	url="";													// If drupal, kill url
	if (url) {																// If a url spec'd
		curPage=0;															// Assume 1st page
		if (url.split("|")[1]) {											// If a page set
			curPage=url.split("|")[1]-1;									// Extract it
			inhibitNav=true;												// Set flag to inhibit navigation
			url=url.split("|")[0];											// Just use id
			}
		if (url && !isNaN(url)) {											// If a number
			url="//qmediaplayer.com/loadshow.php?password=*&id="+url;		// Get from db
			}	
		else if ((url) && (!url.match(/\./)))								// No file extension
			url+=".json";													// Add txt
		curMenu="show";														// Show mode
		$.ajax({ url: url, dataType:'jsonp' });								// Get jsonp and call LoadShow() from it
		}
	
	if (window.addEventListener) 											// If supported this way
		window.addEventListener("message",html5MessageHandler,false);		// Add event handler
	else																	// Use other method
		window.attachEvent("message",html5MessageHandler);					// Add handler

	if (curMenu == "show") { 												// Showing
		$("#splashDiv").css("visibility","hidden");							// Hided splash				
		$("body").css({ "margin":"0px","padding":"0px" });					// No margins or padding
		var str="<div id='showDiv' class='sf-show'></div>";					// Set container div
		$("body").html(str);												// Add to body
		}				 
	else{																	// Editing
		$("#splashDiv").animate({ opacity:0},1000, function(){				// Hide logo
			$("#splashDiv").css("visibility","hidden");							
			});		
									
		$("#mainDiv").animate({ opacity:1},2000, function() {				// Animate in content		
			$("#mainDiv").css("opacity",1);									// Force full
			if (!drupalMan)													// Not from drupal, or not just showing
				dataObj.Load();												// Log in
			});
		}
	$("#itemMenu").on("click",function() { 
		curMenu="item";
		Sound("click");												
		sf.Draw();
		});
	$("#portfolioMenu").on("click",function() { 
		curMenu="project";
		Sound("click");												
		sf.Draw();
		});
	$("#shareMenu").on("click",function() { 
		shareObj.Set(sf.projects[curProject]);	
		});
	$("#helpMenu").on("click",function() { 
		curMenu="help";
		Sound("click");												
		sf.Draw();
		});
	
	$("#editMenu").on("click",function(e) { 
		var l=$(this).position().left+92;
		var t=$(this).position().top+23;
		$("#editMenu").css("color","#009900");										
		$("#editDiv").remove();
		var str="<div class='sf-pullDown' style='left:"+l+"px;top:"+t+"px' id='editDiv'>";
		if (dataObj.curShow)												// A valid show, allow saving
			str+="<div class='sf-pullDownItem' style='color:#000' onclick='dataObj.Save()'> Save </div>";
		str+="<div class='sf-pullDownItem' onclick='dataObj.Save()'> Copy </div>";
		str+="<div class='sf-pullDownItem' onclick=''dataObj.Load()'> Paste </div>";
		str+="<div id='undoMenu' class='sf-pullDownItem' onclick='sf.UnDo()'> Undo</div>";
		str+="</div>";
		$("body").append(str);
		$("#undoMenu").css("color",sf.changed ? "#000" : "#999");			// Show active undos available

		$("#editDiv").on("mouseleave",function() { 
			$("#editDiv").remove();
			$("#editMenu").css("color","#000");										
			});
		
		$("#editDiv").on("click",function(e) { 
			var i=Math.floor(Math.max(0,Math.min((e.clientY-42)/24,4)));
			$("#editDiv").remove();
			$("#editMenu").css("color","#000");	
			});
	
		});
	
	});									
		
function folio()														// CONSTRUCTOR
{
	sf=this;																// Point to folio
	this.projects=[];														// Holds project
	this.items=[];															// Holds items
	this.userInfo={ firstName:"Not", lastName:"logged in"};					// Holds user information
	this.templates=defTemplates;											// Holds templates, fill with default

this.projects=projects;	 projects=undefined;						////////////// REPLACE !!!!												
this.items=items; items=undefined;
	
	this.Init("");															// Init folio
	this.Draw();															// Draw 
	}	

folio.prototype.Init=function(data, mode)								// INIT 
{
	var i,last=-1;
	if (data && (mode == "set")) {											// Set mode						
		this.projects=[];  	this.items=[];		this.userInfo={};			// Start fresh
		this.templates=defTemplates;										// Load default templates
		if (data.projects != undefined)	 this.projects=data.projects;		// Set projects
		if (data.items != undefined)	 this.items=data.items;				// Set items
		if (data.userInfo != undefined)	 this.userInfo=data.userInfo;		// Set info
		if (data.templates != undefined) this.templates=data.templates;		// Set templates
		}
	else if (data && (mode == "add")) {										// Add mode						
		if (data.projects != undefined)	 this.projects=this.projects.concat(data.projects);	// Add projects
		if (data.items != undefined)	 this.items=this.items.concat(data.items);			// Add items
		if (data.templates != undefined) this.templates=data.templates;						// Add templates
		}
	if (this.userInfo.curTemplate != undefined)								// If a template set
		this.userInfo.curTemplate=Math.min(this.userInfo.curTemplate,this.templates.length-1);	// Use it
	
	for (i=0;i<this.projects.length;++i) 									// For each project
		this.InitProject(i);												// Init
	
	if (this.userInfo.lastProject != undefined)								// A valid last project stored
		last=this.userInfo.lastProject;										// Use it
	curProject=Math.min(this.projects.length-1,last);						// Init on last project
	this.changed=0;															// Changed counter
}

folio.prototype.InitProject=function(num)								// INIT PROJECT
{
	if (!this.projects[num].pages)											// If no pages yets
		this.projects[num].pages=[];										// Allocate array
	var t=dataObj.FindFromID(this.templates,this.projects[num].template);	// Get template from project
	layoutObj.Init(this.projects[num],this.templates[Math.max(t,0)]);		// Init project's layout object (use def template if bad)
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DRAW
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


folio.prototype.Draw=function()											// DRAW PAGE (Use sf instead of this!)
{
	var h=window.innerHeight;												// Get height
	var w=window.innerWidth;												// Get width
	$("#sfNavigationBar").remove();											// Remove any previous nav
	if ((curProject != -1) && sf.projects[curProject])						// A valid project
		curPage=Math.min(sf.projects[curProject].pages.length-1,curPage);	// Cap at maxpages
	if (curMenu == "show")	{												// If showing only
		if (curProject == -1)												// No project
			return 	$("#showDiv").html("<br> No portfolio found!");			// Not found
		var o=sf.projects[curProject].pages[curPage];						// Point at page
		if (!o)																// No page
			return 	$("#showDiv").html("<br> No pages found!");				// Not found
		var r=.75;															// Portrait
		var asp=sf.projects[curProject].layout.aspect;						// Start with default
		if (o.layout && (o.layout.aspect != undefined))						// If a layout val set
			asp=o.layout.aspect;											// Use page override
		if (asp == "Square")			r=1;								// Square
		else if (asp == "Landscape")	r=1.5;								// Landscape
		$("#showDiv").width(r*h);											// Set width		
		$("#showDiv").html(playerObj.Make(true));							// Create divs for player
		playerObj.Update(sf.projects[curProject].pages[curPage],sf.projects[curProject].layout);	// Update player obj
		return;
		}
	$("#bodyDiv").height(h-54);												// Set body height
	sf.DrawMenu();															// Set menu
	sf.DrawBody();															// Draw body
	if (curMenu == "splash")												// If splash
		return;																// Quit
	sf.AddProjectItems();													// Add project items
	$("#itemPickerDiv").height(h-90);										// Set picker height
	$("#itemPickerDiv").width(w-$("#projectDiv").width()-$("#galleryDiv").width()-92);					// Set picker width 
	$("#itemPickerDiv").css("left",$("#projectDiv").width()+$("#projectDiv").offset().left+16+"px");	// Set picker left 
	if (curMenu == "project")												// If a project
 		sf.AddProjectHandlers();											// Add project handlers
	else if (curMenu == "page")												// If a page
		sf.AddPageHandlers();												// Add page handlers
	else if (curMenu == "item")												// If item
 		itemObj.AddHandlers();												// Add item handlers
}
		
folio.prototype.DrawMenu=function()										// DRAW MENU AREA
{
	$('[id$="Menu"]').css("color","#000");									// Reset
	$("#editDiv").remove();													// Kill edit menu if left open
	var str="<b>"+this.userInfo.firstName+" "+this.userInfo.lastName+"</b>";// Add name
	$("#pageMenu").css("color","#00aa00");									// Highlight it
	if ((curProject != -1) && this.projects[curProject].title)	{			// A valid project
		str+=" &nbsp;|&nbsp; ";												// Add to breadcrumb
		str+=ShortenString(this.projects[curProject].title,20);				// Add title
		}
	if (curPage != -1)														// A page set
		str+=" &nbsp;|&nbsp; "+(curPage-0+1);								// Add to breadcrumb
	if (curMenu == "item") 													// If item
		$("#itemMenu").css("color","#00aa00");								// Highlight it
	else if (curMenu == "help") 											// If help
		$("#helpMenu").css("color","#00aa00");								// Highlight it
	$("#breadMenu").html(str);												// Set breadcrumb
}

folio.prototype.DrawBody=function()										// DRAW BODY AREA
{
	var str="";
	if (curMenu == "project") {												// If a project
		if ((curProject < 0) && this.projects.length)						// Nothing selected and something there
			curProject=0;													// Pick first one
		str+=this.MakeGallery();											// Add Gallery
		str+=this.MakeProjectPage();										// Add project page
		str+="<div id='itemPickerDiv' class='sf-itemsPicker'></div>";		// Item picker container
		}
	else if (curMenu == "page") {											// If page
		str+=this.MakeGallery();											// Add Gallery
		str+=this.MakePagePage();											// Add page page
		str+="<div id='itemPickerDiv' class='sf-itemsPicker'></div>";		// Item picker container
		}
	else if (curMenu == "help") {											// If help
		str+="<div id='projectDiv' class='sf-projectPage' style='left:0px;width:50%;min-width:500px'>";	// Project container
		str+="<iframe frameborder='0' height='"+(window.innerHeight-90)+"' width='100%' src='";
		str+="//docs.google.com/document/d/1IEtDo0jMhtaVyFeewcB_UXHWirO2Al_jO6Ri7u1QYoI/pub?embedded=true'/></div>";
		}
	else if (curMenu == "edit") {											// If edit
		str+="<div id='projectDiv' class='sf-projectPage' style='left:0px;width:50%;min-width:500px'>";	// Project container
		}
	else if (curMenu == "splash") {											// If splash
		str="<div style='width:100%;text-align:center'><br><br><br>";
		str+="<div class='sf-doButs'><img src='img/addSplash.gif' style='width:25vw' onclick='curMenu=\"item\";sf.Draw(); Sound(\"click\");'>";
		str+="<p style='color:#990000'>Items</p></div>";
		str+="<div class='sf-doButs'><img src='img/editSplash.gif' style='width:25vw' onclick='curMenu=\"project\";sf.Draw(); Sound(\"click\");'>";
		str+="<p style='color:#009900'>Portfolios</p></div>";
		str+="<div class='sf-doButs'><img src='img/shareSplash.gif' style='width:25vw' onclick='curMenu=\"project\";sf.Draw(); Sound(\"click\");'>";
		str+="<p style='color:#000099'>Share</p></div></div>";
		}
	else if (curMenu == "item") 											// If item
		str+=itemObj.MakePage();											// Add item page
	$("#bodyDiv").html(str);												// Fill body
}
	
folio.prototype.MakeGallery=function()									// MAKE GALLERY 
{
	var i,j,o,n=0;labs=[];
	var h=$("#bodyDiv").height()-60;										// Get height											
	if (curMenu == "page")													// If page
		h-=29; 																// Accomodate lay0ut button
	
	var trsty=" onMouseOver='this.style.backgroundColor=\"#dee7f1\"' ";		// Hover style
	trsty+="onMouseOut='this.style.backgroundColor=\"#f8f8f8\"'";
	var str="<div id='galleryDiv' class='sf-gallery'><p><b>Portfolios</b></p>";	// Make gallery div
	str+="<div class='sf-galleryContent' style='height:"+(h-20)+"px'>";		// Scrollable container

	if (!this.projects.length)												// No projects yet
		str+="<br>Add a new portfolio by clicking on the + icon below";		// Say so
	for (i=0;i<this.projects.length;++i) {									// For each project
		labs[i]=this.projects[i].title;										// Set label
		str+="<div id='galleryLab"+i+"'"+trsty+" class='sf-galleryLab' title='Set portfolio'><span";
		if (i == curProject) {												// If the current project
			str+=" style='color:#009900'>"+labs[i]+"</span><br><br>"		// Color it
			o=this.projects[curProject].pages;								// Point at pages
			for (j=0;j<o.length;++j) {										// For each page
				str+="<div class='sf-galleryPage' id='galleryPage"+j+"' title='Set page'";	// Page start
				str+="onMouseOver='this.style.color=\"#009900\"' ";			// Mouse over
				str+="onMouseOut='this.style.color=\"#999\"'>";				// Mouse out
				if (curPage == j)	
					str+="<span style='color:#009900'>&#10148; Page "+(j+1)+" <span style='opacity:0'>&#10148;</span></span></div>";	// Show page
				else
					str+="Page "+(j+1)+"</div>";							// Show page
				}
			str+="</div>";													// Close portfolio div
			}
		else																// Non-curret project
			str+=">"+labs[i]+"</span></div>";								// Close
		}
	str+="</div>";
	str+="<div class='sf-galleryTool'>";
	str+="<img id='galleryAddBut' class='sf-galleryBut' src='img/addbut.gif' title='Add new project'>";
	str+="<img id='galleryCopyBut' class='sf-galleryBut'src='img/copybut.gif'  title='Copy a project'>";
	str+="<img id='galleryTrashBut' class='sf-galleryBut' src='img/trashbut.gif' style='margin-right:0px' title='Remove a project'>";
	if (curMenu == "page")	
		str+="<div style='height:7px'></div>&nbsp;<button class='sf-bs' id='setLayout'>Change page's layout</button>";	// Set layout button
	str+="</div></div>";
	return str;																// Return gallery
}

	function html5MessageHandler(e)										// ON HTML5 MESSAGE
	{
  		if (e && e.data)													// If message
 			if (!e.data.match(/|Mandala/))									// Not from Folio
 				return;														// Quit
		var o={};															// Clean object
		var v=e.data.split("|");											// Get data
		if (v[0].toLowerCase() == "set") {									// Get data
			o=$.parseJSON(v[2]);											// Turn into object and set
			sf.Init(o,"set");												// Init folio
			SendMessage("done");											// Send done mnessage
			sf.Draw();														// Draw 
			}
		else if (v[0].toLowerCase() == "add") {								// Get project(s)
			o=$.parseJSON(v[2]);											// Turn into object and set
			sf.Init(o,"add");												// Init folio
			SendMessage("done");											// Send done mnessage
			sf.Draw();														// Draw 
			}
		else if (v[0].toLowerCase() == "get") {								/// Get data
			if (v[2] == "project")			o=sf.projects;					// Get project(s)			
			else if (v[2] == "item")		o=sf.items;						// Get items(s)			
			else if (v[2] == "userinfo")	o=sf.userInfo;					// Get userinfo			
			else if (v[2] == "template")	o=sf.templates;					// Get templates(s)			
			else							o=sf;							// Whole thing
			SendMessage("data",JSON.stringify(o));							// Return data
			}
 	}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// PROJECTS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	
folio.prototype.MakeProjectPage=function()								// MAKE PROJECT PAGE
{
	var i,v=[];
	var projTitle="",projDesc="",projCite="",projTags="",projCollab=[],projFormat="Booklet",projTemp="";
	var str="<div id='projectDiv' class='sf-projectPage'>";					// Project container
	if (curProject < 0) 													// No project selected
		return str+"</div>";												// Return empty page
	if (this.projects[curProject].title)  	projTitle=this.projects[curProject].title;
	if (this.projects[curProject].desc)   	projDesc=this.projects[curProject].desc;
	if (this.projects[curProject].cite)   	projCite=this.projects[curProject].cite;
	if (this.projects[curProject].tags)   	projTags=this.projects[curProject].tags;
	if (this.projects[curProject].format)   projFormat=this.projects[curProject].format;
	if (this.projects[curProject].collab) 	projCollab=this.projects[curProject].collab.split(",");
	str+="<table style='width:100%;font-weight:bold;text-align:left'>";
	str+="<tr height='32'><td width='1%'>Title</td>";
	str+="<td><input class='sf-is' id='projTitle' ";
	str+="type='text' value='"+projTitle+"'></td></tr>";
	str+="<tr height='28'><td>Description</td><td><textarea class='sf-is' id='projDesc' ";
	str+="style='font-family:sans-serif'>"+projDesc+"</textarea></td></tr>";
	str+="<tr height='28'><td>Citation</td>";
	str+="<td><input class='sf-is' id='projCite' ";
	str+="type='text' value='"+projCite+"'></td></tr>";
	str+="<tr height='28'><td>Tags</td>";
	str+="<td><input class='sf-is' id='projTags' type='text' value='"+projTags+"'></td></tr>";
	str+="<tr height='28'><td>Collaborators</td>";
	str+="<td>"+MakeSelect("projCollab",false,projCollab);
	str+="<img id='collabAddBut' class='sf-galleryBut' src='img/addbut.gif' style='vertical-align:-4px;margin-left:16px;margin-right:8px' title='Add a new collaborator'>";
	str+="<img id='collabTrashBut' class='sf-galleryBut' src='img/trashbut.gif' style='vertical-align:-4px;margin-right:0px' title='Remove a collaborator'></td></tr>";
	str+="<tr height='28'><td>Presention&nbsp;format&nbsp;&nbsp</td><td>";
	str+=MakeSelect("projFormat",false,["Booklet","Single page","Canvas","Slide show","Up/Down"],projFormat)+"</td></tr>";
	str+="<tr height='28'><td>Template</td><td>";
	for (i=0;i<this.templates.length;++i)	v.push(this.templates[i].name);	
	str+=MakeSelect("projTemp",false,v,v[this.userInfo.curTemplate]);
	str+="<img id='tempAddBut' class='sf-galleryBut' src='img/addbut.gif' style='vertical-align:-4px;margin-left:16px;margin-right:8px' title='Add a new termplate'>";
	str+="<img id='tempTrashBut' class='sf-galleryBut' src='img/trashbut.gif' style='vertical-align:-4px;margin-right:0px' title='Remove a template'></td></tr>";
	str+="<tr height='50'><td colspan='2' style='text-align:center'>";
	str+="<button class='sf-bs' style='width:90px' id='setLayout'>Set layout</button>&nbsp; &nbsp;";	// Set layout button
	str+="<button class='sf-bs' style='width:90px' id='addPages'>Add items</button>&nbsp; &nbsp;";		// Add items button
	if (dataObj.curShow)																				// A valid show
		str+="<button class='sf-bs' style='width:90px' id='saveButton'>Save</button>";					// Add Saves button
	str+="</table>";
	str+="<div id='projectItemsDiv' class='sf-projectItems'></div>";		// Items div
	return str+"</div>";													// Return project page
}
	
folio.prototype.AddProjectHandlers=function()							// ADD PROJECT HANDLERS
{

	$("#galleryAddBut").on("click",function() { 							// ADD NEW PROJECT
		sf.Do()																// Something changed
		sf.projects.push({ title:"New project", cite:"", items:[] });		// Add shell					
		curProject=sf.projects.length-1;									// Point at it
		sf.userInfo.lastProject=curProject;									// Save last project index
		sf.projects[curProject].id=MakeUniqueId();							// Create new id
		sf.InitProject(curProject);											// Init project
		Sound("add");														// Add
		sf.Draw();															// Redraw
		});

	if (curProject < 0)														// If not a valid project										
			return;															// Quit
	
	this.AddProjectItems(true);												// Add project items
	
	$('[id^="gallery"]').off();												// Clear old handlers
	$('[id^="proj"]').off();												// Clear old handlers
	
	$('[id^="galleryPage"]').on("click",function(e) {						// ON PAGE CLICK
		curPage=e.currentTarget.id.substr(11)-0;							// Extract curPage from id
		curMenu="page";														// Edit page mode
		Sound("click");														// Click
		sf.Draw();															// Redraw
		});

	$('[id^="galleryLab"]').on("click", function(e) {						// ON PROJECT CLICK
		curProject=e.currentTarget.id.substr(10)-0;							// Extract id
		curMenu="project";													// Edit object mode
		curPage=-1;															// No page set
		sf.userInfo.lastProject=curProject;									// Save last project index
		Sound("click");														// Click
		sf.Draw();															// Redraw
		});

	$("#projTitle").on("change",function() { 								// If changed
		sf.Do()																// Something changed
		sf.projects[curProject].title=Escape($("#projTitle").val(),true);	// Set it	
		});
	
	$("#projDesc").on("change",function() { 								// If changed
		sf.Do()																// Something changed
		sf.projects[curProject].desc=Escape($("#projDesc").val(),true);		// Set it	
		});
	
	$("#projCite").on("change",function() { 								// If changed
		sf.Do()																// Something changed
		sf.projects[curProject].cite=Escape($("#projCite").val(),true);		// Set it	
		});
	$("#projTags").on("change",function() { 								// If changed
		sf.Do()																// Something changed
		sf.projects[curProject].tags=Escape($("#projTags").val(),true);		// Set it	
		});
	
	$("#projFormat").on("change",function() { 								// If changed
		sf.Do()																// Something changed
		sf.projects[curProject].format=$("#projFormat").val();				// Set it	
		Sound("click");														// Click
		sf.Draw();															// Redraw
		});
	
	$("#projTemp").on("change",function() { 								// If changed
		ConfirmBox("This will remove any changes you have made to the layout, and replace them with the defaults from the template named <b>"+$(this).val()+".</b>", function() {
			sf.Do()															// Something changed
			sf.userInfo.curTemplate=$("#projTemp").prop("selectedIndex");	// Get index
			var t=sf.projects[curProject].template=sf.templates[sf.userInfo.curTemplate].id;	// Get id of template and set in project	
			t=Math.max(dataObj.FindFromID(sf.templates,t),0);				// Get index (use def template if bad)
			layoutObj.Init(sf.projects[curProject],sf.templates[t]);		// Init project's layout object 
			Sound("ding");													// Click
			sf.Draw();														// Redraw
			});
		});

	for (i=0;i<sf.projects.length;++i)										// For each project
		$("#galleryLab"+i).on("click", function(e) {						// ON PROJECT CLICK
			curProject=e.currentTarget.id.substr(10)-0;						// Extract id
			sf.userInfo.lastProject=curProject;								// Save last project index
			Sound("click");													// Click
			sf.Draw();														// Redraw
			});

	$("#projFilter").on("change",function() { 								// If changed
		itemFilter=$("#projFilter").val();									// Set it	
		sf.Draw();															// Redraw
		});

	$("#projType").on("change",function() { 								// If changed
		itemType=$("#projType").val();										// Set it	
		sf.Draw();															// Redraw
		});
	
	$("#galleryCopyBut").on("click",function() { 							// COPY A PROJECT
		if (curProject < 0)													// If not a valid project										
			return;															// Quit
		GetTextBox("Type project name", "This is the name of the new project made from the current one", "", function(s) {	// Ask for name
			var o=JSON.stringify(sf.projects[curProject]);					// Deep copy current project as JSON
			sf.Do()															// Something changed
			sf.projects.push($.parseJSON(o));								// Add copy as object					
			curProject=sf.projects.length-1;								// Point at it
			sf.projects[curProject].title=s;								// Change title
			sf.userInfo.lastProject=curProject;								// Save last project index
			sf.projects[curProject].id=MakeUniqueId();						// Create new id
			sf.InitProject(curProject);										// Init project
			Sound("add");													// Add
			sf.Draw();														// Redraw
			});
		});
	
	$("#galleryTrashBut").on("click",function() { 							// DELETE PROJECT
		if (curProject < 0)													// If not a valid project										
			return;															// Quit
		ConfirmBox("This will delete the project:<br><br><b><i>"+sf.projects[curProject].title+"</b></i>", function() {
			sf.Do()															// Something changed
			sf.projects.splice(curProject,1);								// Remove it
			curProject--;													// Go to previous projcet
			Sound("delete");												// Delete
			sf.Draw();														// Redraw
			});
		});

	$("#collabAddBut").on("click",function() { 								// ADD NEW COLLABORATOR
		GetTextBox("Type name of collaborator", "", "", function(s) {		// Ask for name
			sf.Do()															// Something changed
			if (sf.projects[curProject].collab)								// If not first one
				sf.projects[curProject].collab+=","+s;						// Add new collaborator
			else															// Frist one one
				sf.projects[curProject].collab=s;							// Add first collaborator
			Sound("add");													// Add
			sf.Draw();														// Redraw
			$("#projCollab").val(s);
		});
	});

	$("#collabTrashBut").on("click",function() { 							// DELETE COLLABORATOR
			var s=$("#projCollab").val();
			if (!s)															// Nothing selected
				return;														// Quit
		ConfirmBox("This will delete  <b>"+s+" </b>from the project", function() {
			sf.Do()															// Something changed
			var v=sf.projects[curProject].collab.split(",");				// Make into array		
			v.splice($("#projCollab").prop('selectedIndex'),1);				// Delete it
			sf.projects[curProject].collab=v.toString();					// Combine into string
			Sound("delete");												// Delete
			sf.Draw();														// Redraw
			});
		});

	$("#tempAddBut").on("click",function() { 								// ADD NEW TEMPLATE
		GetTextBox("Type new template name", "Type a short name of the new template. This will create a new template, based on the current one.<br><br>To simply update the current template, don't put in a new name and leave this box blank.", "", function(s) {		// Ask for name
			sf.Do()															// Something changed
			var o=(JSON.stringify(sf.projects[curProject].layout));			// Deep copy current layout as JSON
			if (s) {														// A new template to be made
				sf.templates.push($.parseJSON(o));							// Add copy as object					
				sf.templates[sf.templates.length-1].name=s;					// Set new name
				sf.templates[sf.templates.length-1].id=MakeUniqueId();		// Set new id
				sf.userInfo.curTemplate=sf.templates.length-1;				// Set index
				}			
			else	
				sf.templates[sf.userInfo.curTemplate]=($.parseJSON(o));		// Set copy as object					
			var t=sf.projects[curProject].template=sf.templates[sf.userInfo.curTemplate].id;	// Get id of template and set in project	
			t=Math.max(dataObj.FindFromID(sf.templates,t),0);				// Get index (use def template if bad)
			layoutObj.Init(sf.projects[curProject],sf.templates[t]);		// Init project's layout object 
			Sound("add");													// Add
			sf.Draw();														// Redraw
			});
		});

	$("#galleryCopyBut").on("click",function() { 							// COPY A PROJECT
		if (curProject < 0)													// If not a valid project										
			return;															// Quit
		GetTextBox("Type project name", "This is the name of the new project made from the current one", "", function(s) {	// Ask for name
			var o=JSON.stringify(sf.projects[curProject]);					// Deep copy current project as JSON
			sf.Do()															// Something changed
			sf.projects.push($.parseJSON(o));								// Add copy as object					
			curProject=sf.projects.length-1;								// Point at it
			sf.projects[curProject].title=s;								// Change title
			sf.userInfo.lastProject=curProject;								// Save last project index
			sf.projects[curProject].id=MakeUniqueId();						// Create new id
			sf.InitProject(curProject);										// Init project
			Sound("add");													// Add
			sf.Draw();														// Redraw
			});
		});


	$("#tempTrashBut").on("click",function() { 								// DELETE TEMPLATE
			var s=$("#projTemp").val();										// Get current val
			if (!s)															// Nothing selected
				return;														// Quit
			if (sf.userInfo.curTemplate)									// Can't remove default
				ConfirmBox("This will delete the template named <b>"+s+" </b>from the project.", function() {
					var i;
					sf.Do()													// Something changed
					var tid=sf.templates[sf.userInfo.curTemplate].id;		// Get leaving template's id
					for (i=0;i<sf.projects.length;i++)						// For each project
						if (sf.projects[i].template == tid)					// Uses this one
							sf.projects[i].template=0;						// Use default	
					sf.templates.splice(sf.userInfo.curTemplate,1);			// Remove it
					sf.userInfo.curTemplate=0;								// Set to default template
					Sound("delete");										// Delete
					sf.Draw();												// Redraw
					});
		});

	$("#projectDiv").droppable({
		 drop: function(event, ui) {										// On drop
			if (ui.draggable.prop("id").substr(0,5)== "item-") {			// From items corpus
				sf.Do()													   	// Something changed
		 		var id=ui.draggable.prop("id").substr(5);					// Point at item's index
		 		id=sf.items[id].id;											// Get item's unique id
		 		sf.projects[curProject].items.push(id);						// Add to items
				Sound("add");											 	// Add
				sf.AddProjectItems();								 	 	// Add project items
				}
			}
		 });
	
	$("#addPages").on("click",function() { 									// ADD PAGES
		if (sf.projects[curProject].items && !sf.projects[curProject].items.length)		// If no items 
			return;															// Quit
		var str="This will add a page for each item in the portfolio, in the order they are in now."
		str+="You can reorder and edit them in the Page editor.<br><br>";
		str+="<b>NOTE: </b>This will remove any pages you already have made!"
		ConfirmBox(str, function() {										// Confirm it
			sf.Do()															// Something changed
			sf.AddPages();													// Add pages
			curMenu="page";													// Set for page
			sf.Draw();														// Redraw
			});
		});

	$("#setLayout").on("click",function() { 								// SET LAYOUT
		sf.Do()																// Something changed
		layoutObj.Set(sf.projects[curProject],sf.templates[sf.userInfo.curTemplate]);	// Set layout
		});

	$("#saveButton").on("click",function() { 								// SAVE
		dataObj.Save();														// Save it
		});
}	

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// PAGES
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


folio.prototype.MakePagePage=function(showOnly)							// MAKE PAGE PAGE
{
	var str="<div id='projectDiv' class='sf-projectPage' style='width:";	// Set project div
	if ((curProject < 0) || (curPage < 0)) {								// No project, page selected
		str+=$("#bodyDiv").height()*.75+"px'>";								// Set width
		return str+"</div>";												// Return empty page
		}
	var o=this.projects[curProject].pages[curPage];							// Point at page

	var r=.75;																// Portrait
	var asp=this.projects[curProject].layout.aspect;						// Start with default
	if (o && o.layout && (o.layout.aspect != undefined))					// If a layout val set
		asp=o.layout.aspect;												// Use page override
	if (asp == "Square")			r=1;									// Square
	else if (asp == "Landscape")	r=1.5;									// Landscape
	str+=$("#bodyDiv").height()*r+"px'>";									// Set width
	str+=playerObj.Make(showOnly);											// Create divs for player
	return str+"</div>";													// Return page page
}

folio.prototype.AddPageHandlers=function()								// ADD PAGE HANDLERS
{

	$("#galleryAddBut").on("click",function() { 							// ADD A PAGE
		if (curProject < 0)													// If not a valid project									
			return;															// Quit
		var p=sf.projects[curProject].pages;								// Point p at pages array
		if (!p) p=sf.projects[curProject].pages=[];							// Create it														
		sf.Do()																// Something changed
		p.push({ title:"New page"});										// Add page
		curPage=p.length-1;													// Point at it
		Sound("add");														// Add
		sf.Draw();															// Redraw
		});


	if (!this.projects[curProject].pages)
		return;
		
	playerObj.Update(this.projects[curProject].pages[curPage],this.projects[curProject].layout);	// Add player obj
	
	$('[id^="galleryPage"]').on("click",function(e) {						// ON PAGE CLICK
		$("#alertBoxDiv").remove();											// Remove any old dialogs
		curPage=e.currentTarget.id.substr(11)-0;							// Extract curPage from id
		curMenu="page";														// Edit page mode
		Sound("click");														// Click
		sf.Draw();															// Redraw
		});

	$('[id^="galleryLab"]').on("click", function(e) {						// ON PROJECT CLICK
		$("#alertBoxDiv").remove();											// Remove any old dialogs
		curProject=e.currentTarget.id.substr(10)-0;							// Extract id
		curMenu="project";													// Edit project mode
		curPage=-1;															// No page set
		sf.userInfo.lastProject=curProject;									// Save last project index
		Sound("click");														// Click
		sf.Draw();															// Redraw
		});

	for (var i=0;i<sf.projects[curProject].pages.length;++i) {				// For each page
		
		$("#galleryPage"+i).draggable( {	zIndex:100 });					// MAKE PAGE LABELS DRAGGABLE
		 	
		$("#galleryPage"+i).droppable({ 									// MAKE PAGES DROPPABLE
			 accept: ".sf-galleryPage",										// Accept only pages
			 drop: function(event, ui) {									// On drop
				sf.Do()														// Something changed
				var p=sf.projects[curProject].pages;						// Point p at current project pages
				var from=ui.draggable.prop('id').substr(11);				// Get id of dragged page
				var to=$(event.target).prop('id').substr(11);				// Get id of receiver page
				var t=p[to];												// Save to item
				p[to]=p[from];												// Copy from -> to
				p[from]=t;													// Reset to
				Sound("add");												// Add
				sf.Draw();													// Redraw
				}
			 });
	}

	$("#galleryCopyBut").on("click",function() { 							// COPY A PAGE
		if ((curPage < 0) || (curProject < 0))								// If not a valid project/page										
			return;															// Quit
		var p=sf.projects[curProject].pages;								// Point p at pages
		sf.Do()																// Something changed
		p.push($.parseJSON(JSON.stringify(p[curPage])));					// Copy as object					
		curPage=p.length-1;													// Point at it
		Sound("add");														// Add
		sf.Draw();															// Redraw
		});
	
	$("#galleryTrashBut").on("click",function() { 							// DELETE PROJECT
		if ((curPage < 0) || (curProject < 0))								// If not a valid project/page										
			return;															// Quit
		ConfirmBox("This will delete this page", function() {				// Sure?
			sf.Do()															// Something changed
			var p=sf.projects[curProject].pages;							// Point p at pages
			p.splice(curPage,1);											// Remove it
			curPage--;														// Go to previous projcet
			Sound("delete");												// Delete
			sf.Draw();														// Redraw
			});
		});

	$("#setLayout").on("click",function() { 								// SET PAGE LAYOUT
		sf.Do()																// Something changed
		layoutObj.Set(sf.projects[curProject].pages[curPage],sf.templates[sf.userInfo.curTemplate],sf.Draw);	// Set layout
  		});

	$('[id^="playerPane"]').on("blur",function(e) { 						// EDIT PAGE PANE
		var p=sf.projects[curProject].pages[curPage];						// Point p at page
		var id=e.currentTarget.id.substr(10);								// Extract id
		p["markUp"+id]=$(this).html();										// Copy hlml contents of pane into page
    	});

	$('[id^="playerPane"]').droppable({ 									// MAKE ITEMS DROPPABLE
		 accept: ".sf-pitem",												// Accept only project items
		 drop: function(event, ui) {										// On drop
			sf.Do()															// Something changed
			var p=sf.projects[curProject];									// Point p at current project
			var from=ui.draggable.prop('id').substr(6);						// Get id of dragged item
			var to=$(event.target).prop('id').substr(10);					// Get id of receiver item
			from=p.items[from];												// Get real item index from id
			var str=sf.GetItemMarkup(from);									// Add item to page
			$(this).html(str+$(this).html());								// Add item
			p.pages[curPage]["markUp"+to]=$(this).html();					// Copy html contents of pane into page
			}
		 });
}	

folio.prototype.GetItemMarkup=function(id)								// GET ITEM's MARKUP
{
	var str="";
	if (curProject < 0)														// No project 
		return "";															// Return null
	var p=this.projects[curProject];										// Point p at project
	var o=dataObj.FindFromID(this.items,id);								// Get index from real id
	if (o < 0)																// Not found
		return "";															// Return null
	
	o=sf.items[o];															// Point at item directy
	if (!o)																	// No item
		return "";															// Return null
	if (o.src) {															// If a source
		str+="<br><div id='sfItemDiv-"+MakeUniqueId()+"' class='sf-playerItem' style='width:100%;text-align:"+p.layout.itemAlign+"'>";			// Div for item	
		if (o.src.match(/.mp4/i)) {											// HTML5 video
			str+="<video class='sf-playerItemInt' controls id='sfItem-"+MakeUniqueId()+"' width='"+p.layout.itemWid;	// Tag
			str+="' src='"+o.src+"'/>";										// Src
			}
		else if (o.src.match(/\.png|.gif|\.jpg|.jpeg/i)) 					// An image
			str+="<img id='sfItem-"+MakeUniqueId()+"' class='sf-playerItemInt' width='"+p.layout.itemWid+"' src='"+o.src+"'></div>";
		else{
			str+="<iframe id='sfItem-"+MakeUniqueId()+"' class='sf-playerItemInt' frameborder='0' allowfullscreen "; 
			str+=" style='border:"+p.layout.itemBorder+"' src='"+o.src+"' "; // Style
			str+="width='"+p.layout.itemWid+"' height='"+p.layout.itemHgt+"'></iframe>";
			}
		str+="</div><br>";													// Close div											
		}
	if (o.title) 															// If a title
		str+=StyleText(o.title,p.layout.panes[2].titleStyle)+"<br>"; 		// Style text using middle pane setting
	if (o.desc) 															// If a desc
		str+=o.desc;														// Add it
	if (o.citation) {														// If a citation
		id="sfCite"+MakeUniqueId();											// Make id
		str+="<div class='sf-citation'><br><a onclick='$(\"#"+id+"\").fadeToggle()'>";
		str+="Citation<br><span style='display:none' id='"+id+"'>"+o.citation+"</span></div>";
		}
	if (!o.desc)															// No desc
		str+="<p></p>";														// Add para to make editing easier
	return str;																// Return markup for item
}

folio.prototype.AddPages=function()										// ADD PAGES TO PROJECT
{
	var i,j,po,str;
	var paneNames=["Top","Left","Mid","Right","Bot"];						// Names of the panes
	this.Do();																// Something changed
	var p=this.projects[curProject];										// Point p at project
	p.pages=[];																// Clear pages
	for (i=0;i<p.items.length;++i) {										// For each item in project
		str="";																// Assume nothing
		po={};																// New page object
		for (j=0;j<5;++j) {													// For each pane
			if (p.layout && (p.layout.panes[j].markUp != undefined))		// If a layout markup set for top
				po["markUp"+paneNames[j]]=p.layout.panes[j].markUp;			// Use it
			}		
		str+=this.GetItemMarkup(p.items[i],2)								// Add item markup								
		po.markUpMid+=str;													// Add to markUp
		p.pages.push(po);													// Add page
		}
}

folio.prototype.AddProjectItems=function(showAll)						// ADD ITEMS
{
	var o,i,n,lab,pic,str,div;
	var fil="",typ="all types";
	if ((curMenu == "project") || (curMenu == "page")) {					// If filling project items
		if (curProject < 0)													// No project												
			return;															// Quit
		n=this.projects[curProject].items.length;							// Number of items
		}
	if (showAll) {
		typ=itemType.toLowerCase();											// Type as lc
		fil=itemFilter.toLowerCase();										// Filter as lc
		div="itemPickerDiv";												// Point at item picker
		str="<div style='text-align:center;margin-bottom:16px;'>Show only&nbsp;";			
		str+=MakeSelect("projType",false,["All types"].concat(itemObj.mediaTypeNames,itemType),itemType);
		str+="&nbsp; filtered&nbsp;by&nbsp;&nbsp;<input type='text' class='sf-is' id='projFilter' value='"+itemFilter+"' style='width:80px'> &nbsp;";
		str+="</div>"; 
		n=this.items.length;												// Number of items
		}
	else if (curMenu == "project") {										// Project page
		div="projectItemsDiv";												// Point at project items
		str="<p style='text-align:center'>Drag items to include in project here</p>";
		}
	else if (curMenu == "page") {											// Page page
		div="itemPickerDiv";												// Point at item picker
		str="<div style='text-align:center'>Portfolio items to use (drag to add to page)</div><br>";
		}
	for (i=0;i<n;++i) {														// For each item
		pic=lab="";															// Clear
		if (!this.items[i])													// Nothing there
			continue;														// Skip it
		if (typ != "all types")												// If filtering by type
			if (this.items[i].type.toLowerCase() != typ)					// Not the right one
				continue;													// Skip it
		if (fil) {															// If filtering by text
			lab=this.items[i].title+this.items[i].desc+this.items[i].citation+this.items[i].tags;	// Get certain fields
			if (lab.toLowerCase().indexOf(fil) == -1) 						// If not in there
				continue;													// Skip it
			}
		if (showAll) {														// Showing all items
			o=this.items[i];												// Point at items directly
			str+="<div id='item-"+i+"' class='sf-item'>";					// Add item container for items
			}
		else{																// Show only project items
			o=dataObj.FindFromID(this.items,this.projects[curProject].items[i]);	// Get item index fron item id
			if (o < 0)														// Invalid
				continue;													// Skip it
			o=this.items[o];												// Point at item directly
			str+="<div id='pitem-"+i+"' class='sf-pitem'>";					// Add item container for pitems
			}
		if (o.title)														// If a title
			lab=ShortenString(o.title,35);									// Add it
		if (o.thumb)														// If a thumb
			pic=o.thumb;													// Add it
		else																// Use generic images
			pic=GetMediaIcon(o.type,o.src);									// Get icon
		str+="<div class='sf-itemPic'>";									// Image container div
		str+="<img src='"+pic+"' width='100%'></div>"+lab+"</div>";			// Add pic	
		}
	$("#"+div).html(str);													// Add items to div
	if ((curMenu == "project") || (curMenu == "page")) 						// If filling project items
		for (i=0;i<n;++i) {													// For each item in project

			$("#pitem-"+i).off("dblclick");	 								// Remove dblclick handlers
			$("#pitem-"+i).off("doubletap");	 							// Remove doubletap handlers

			$("#pitem-"+i).draggable({ 										// Make item draggable
				helper:'clone',appendTo:'body',			 					// Beyond parent frame
				stop: function(e, ui) {										// On stop dragging
					if ((curMenu == "project") && ((ui.position.left > 600) || (ui.position.left < 100))) {	// Out of project items box
						sf.Do()												// Something changed
				 		sf.projects[curProject].items.splice(e.target.id.substr(6),1);	// Remove it
						Sound("delete");									// Delete
						sf.AddProjectItems();								// Add project items
						}
					}
				});
				
			$("#pitem-"+i).droppable({ 										// Make item droppable
				 accept: ".sf-pitem",										// Accept only project items
				 drop: function(event, ui) {								// On drop
					var from=ui.draggable.prop('id').substr(6);				// Get id of dragged item
					var to=$(event.target).prop('id').substr(6);			// Get id of receiver item
					if (curMenu == "project") {								// Project
						sf.Do()												// Something changed
						var o=sf.projects[curProject].items;				// Point at items
						var t=o[to];										// Save to item
						o[to]=o[from];										// Copy from -> to
						o[from]=t;											// Reset to
						Sound("click");										// Click
						sf.AddProjectItems();								// Add project items
						}
					}
				 });

			$("#pitem-"+i).on("dblclick",function() {						// ON DOUBLE CLICK
				var id=$(this).prop("id").substr(6);						// Get id of project item
				id=sf.projects[curProject].items[id];						// Get real id
				itemObj.Preview(id);										// Preview		
				});

			$("#pitem-"+i).on("doubletap",function() {						// ON DOUBLE CLICK MOBILE
				var id=$(this).prop("id").substr(6);						// Get id of project item
				id=sf.projects[curProject].items[id];						// Get real id
				itemObj.Preview(id);										// Preview		
				});
			}

		if (showAll) {														// Showing all items
			for (i=0;i<n;++i) {												// For each item
	
				$("#item-"+i).on("dblclick",function() {					// ON DOUBLE CLICK
					var id=$(this).prop("id").substr(5);					// Get id
					itemObj.Preview(sf.items[id].id);						// Preview with real id	
					});

				$("#item-"+i).on("doubletap",function() {					// ON DOUBLE CLICK MOBILE
					var id=$(this).prop("id").substr(5);					// Get id
					itemObj.Preview(sf.items[id].id);						// Preview with real id	
					});
				
				$("#item-"+i).draggable({ 									// Make item draggable
					helper:'clone',appendTo:'body'			 				// Beyond parent frame
					});
				
				}
			}
}	

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// UNDO / REDO
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

folio.prototype.Do=function()											// DO
{
	this.changed++;															// Set change flag
	sessionStorage.setItem("do-"+sessionStorage.length,JSON.stringify(sf));	// Add new do												
	$("#undoMenu").css("color","#000");										// Show active undos available
	SendMessage("do");														// Send do mnessage
}
	
folio.prototype.UnDo=function()											// UNDO
{
	if (!this.changed)														// Nothing to undo 
		return;																// Quit
	var id="do-"+(sessionStorage.length-1);									// Get id of last undo
	var o=$.parseJSON(sessionStorage.getItem(id));							// Get undo from local storage
	if (!o.items && o.projects) {											// Must be invalid
		this.changed=0;														// No changes
		Sound("delete");													// Delete
		return;																// Quit
		}
	sf.projects=o.projects;													// Restore projects
	sf.items=o.items;														// Restore items
	this.Draw();															// Show page
	Sound("ding");															// Ding
	this.changed=Math.max(this.changed-1,0);								// One less undo
}

	
</script>
</body>
</html>
